<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
        <!-- plugins:css -->
        <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
        <link rel="stylesheet" href="../../assets/vendors/flag-icon-css/css/flag-icon.min.css">
        <!-- <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css"> -->
        <link rel="stylesheet" href="./assets/custom/css/style.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icons/7.0.3/css/flag-icons.min.css" integrity="sha512-bZBu2H0+FGFz/stDN/L0k8J0G8qVsAL0ht1qg5kTwtAheiXwiRKyCq1frwfbSFSJN3jooR5kauE0YjtPzhZtJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <!-- endinject -->
        <!-- Plugin css for this page -->
        <!-- End plugin css for this page -->
        <!-- inject:css -->
        <!-- endinject -->
        <!-- Layout styles -->
        <link rel="stylesheet" href="../../assets/css/style.css">
        <link rel="stylesheet" href="./assets/custom/css/style.css">
<style>
.custom-file-input::-webkit-file-upload-button {
  visibility: hidden;
}
.custom-file-input::before {
  content: 'إختر ملف';
  display: inline-block;
  background: linear-gradient(top, #f9f9f9, #e3e3e3);
  border: 1px solid #999;
  border-radius: 3px;
  padding: 5px 8px;
  outline: none;
  white-space: nowrap;
  -webkit-user-select: none;
  cursor: pointer;
  text-shadow: 1px 1px #fff;
  font-weight: 700;
  font-size: 10pt;
}
.custom-file-input:hover::before {
  border-color: black;
}
.custom-file-input:active::before {
  background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
}
.img_wrapper:hover img{
  background-color: #0000;

  opacity: 0.5;
}
.selected{
  background-color: #b4afaf00;
  z-index: 99;

}
.selected img {
    opacity: 0.5;
}
#control{
margin-top: 30px;
margin-bottom: 30px;
padding: 30px;
background-color: #eef0fa;
}
</style>
      </head>
<body>
   
    <div class="container">
<div class="row" id="control">
<div class="offset-lg-1 col-lg-3">
  <label for="ch_img">تغير</label>
  <input class="custom-file-input" id = "ch_img" type="file">
</div>
<div class="col-lg-3">
  <label for="add_img">إضافة الصورة</label>
<input class="custom-file-input" id="add_img" type="file">
</div>
<div class="col-md-1 mt-3">
  <input type="submit" class="btn btn-primary" id = "go_back" value = "رجوع" name="go_back"/>
</div>
<div class="col-md-1 pt-3">
  <button class="btn btn-danger" id = "del_img">حذف</button>

</div>
</div>
      <div class="row" id = "galary">

      </div>  
    </div>
</body>
<script>
  async function getArray(url){
    let myHeaders = new Headers()
    myHeaders.append("Authorization", "Bearer "+localStorage.getItem('token'));
    var options= {
    method: 'Get',
    headers:myHeaders,
   // redirect: 'follow',
    origin:"https://localhost:7168",
  };
  
    try {
          let res = await fetch(url,options);
      //   return await res.json();
  return await res;
      } catch (error) {
          console.log(error);
      }
      //return await res;
  }
  async function getStream(url){
    let myHeaders = new Headers();
    myHeaders.append("Authorization", "Bearer "+localStorage.getItem('token'));
    var options= {
    method: 'Get',
    headers:myHeaders,
   // redirect: 'follow',
    origin:"https://localhost:7168",
  };
  
    try {
          let res = await fetch(url,options);
      //   return await res.json();
  return await res;
      } catch (error) {
          console.log(error);
      }
      //return await res;
  }

async function deleteImg(path){
  let myHeaders = new Headers();
  myHeaders.append("Authorization", "Bearer "+localStorage.getItem('token'));

let url='https://localhost:7168/api/products/deleteFile/?path='+path;
var options= {
    method: 'Delete',
    headers: myHeaders,
   // redirect: 'follow',
    origin:"https://localhost:7168",
  };
  
    try {
          let res = await fetch(url,options);
      //   return await res.json();
  return await res;
      } catch (error) {
          console.log(error);
      }

}
function setOldPath(e){
  console.log(e)
}
window.onload=async function(e){
e.preventDefault();
let id = window.location.search.split('=')[1]
let result = await getArray("https://localhost:7168/api/products/getImageNames/"+id)
let str='';
let current = ''
let old_name='';
//console.log(result)
if(result.status == 200){

let fileNames = await result.json()
let i;
let url = "https://localhost:7168/api/products/AskChat/"+id+"/?path="
for(i = 0 ; i < fileNames.length;i++){
    let x =await getStream(url+fileNames[i])
    let str = await x.blob()
    let div = document.createElement('DIV')
    div.setAttribute("class","col-md-4")
    div.classList.add("img_wrapper")
    div.classList.add("mt-5")
    div.setAttribute("id",fileNames[i])
    let img = document.createElement('img')
    img.src = URL.createObjectURL(str)
    img.style.width="300px";
    img.style.height="300px";
    let eee = fileNames[i]
    img.addEventListener('click',function(e){
old_logo = eee
current = e.target
e.target.parentNode.classList.add("selected")

console.log(e.target)
    })
    div.appendChild(img)

    document.getElementById('galary').appendChild(div)
}
}

document.getElementById('ch_img').addEventListener('change',async function(e){
      e.preventDefault()
if(current == ''){
alert("الرجاء إختيار صورة")
}
str = e.target.files[0]
//alert(old_logo)
current.src = URL.createObjectURL(str)
let ch_btn = document.createElement('button')
ch_btn.setAttribute('class','btn btn-success')
ch_btn.innerText='تغير'
current.parentNode.appendChild(ch_btn)
ch_btn.addEventListener('click',async function(e){
e.preventDefault()
var formdata = new FormData();
console.log(current.src)
formdata.append("old_logo",old_logo);
formdata.append("new_logo", str, "/C:/Users/grani/Downloads/starbox.png");
formdata.append("ID", id);
let myheaders = new Headers();
myheaders.append("Authorization", "Bearer "+localStorage.getItem('token'));
var requestOptions = {
  method: 'POST',
  headers:myheaders,
  body: formdata,
  redirect: 'follow'
};

fetch("https://localhost:7168/api/products/changeFile", requestOptions)
  .then(response => response.text())
  .then(result => console.log(result))
  .catch(error => console.log('error', error));
  window.location.reload()

    })

/////////       change image api       /////////////

})
document.getElementById('del_img').addEventListener('click',function(e){
e.preventDefault()
deleteImg(old_logo)
window.location.reload()

})
document.getElementById('add_img').addEventListener('change',function(e){
  var formdata = new FormData();
formdata.append("str", e.target.files[0]);
let myHeaders = new Headers();
myHeaders.append("Authorization", "Bearer "+localStorage.getItem('token'));
var requestOptions = {
  method: 'POST',
  headers:myHeaders,
  body: formdata,
  redirect: 'follow'
};

fetch("https://localhost:7168/api/products/uploadFile/"+id, requestOptions)
  .then(response => response.text())
  .then(result => console.log(result))
  .catch(error => console.log('error', error));
  window.location.reload()

})
document.getElementById('go_back').addEventListener('click',function(e){
e.preventDefault();
window.location = 'http://127.0.0.1/front_end_api/template/pages/samples/products.html'

})
}
</script>
</html>